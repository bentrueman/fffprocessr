dplyr::ungroup() %>%
dplyr::group_by(!!!rlang::syms(c(group_vars, "peak"))) %>%
dplyr::summarize(
!!x_var := (.data[[x_var]])[which.max(.data[[y_var]])],
!!y_var := max(.data[[y_var]]),
) %>%
dplyr::ungroup() %>%
# select number of peaks, starting with largest
dplyr::group_by(!!!rlang::syms(group_vars)) %>%
dplyr::arrange(dplyr::desc(.data[[y_var]])) %>%
dplyr::slice(seq_len(peaks))
data %>%
dplyr::filter(.data[[x_var]] > focus) %>%
dplyr::mutate(
fitted = mgcv::gam(as.formula(formula_gam)) %>%
mgcv::predict.gam(),
diff = dplyr::lead(.data$fitted) - .data$fitted, # slope
sign = sign(.data$diff), # sign of slope
diff_sign = dplyr::lead(.data$sign) - .data$sign, # delta sign of slope
peak = cumsum(.data$diff_sign > 0)
) %>%
dplyr::ungroup() %>%
dplyr::group_by(!!!rlang::syms(c(group_vars, "peak"))) %>%
dplyr::summarize(
!!x_var := (.data[[x_var]])[which.max(.data[[y_var]])],
!!y_var := max(.data[[y_var]]),
) %>%
dplyr::ungroup() %>%
# select number of peaks, starting with largest
dplyr::group_by(!!!rlang::syms(group_vars)) %>%
dplyr::arrange(dplyr::desc(.data[[y_var]])) %>%
dplyr::slice(seq_len(peaks)) %>%
dplyr::ungroup()
peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "gam")
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam")
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam", peaks = 3)
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam", peaks = 3)
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam", peaks = 4)
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam", peaks = 5)
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "sigma", peaks = 5)
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "sigma")
peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam")
test_that("peak_maxima() works with group_vars = NULL and alternate x and y variable names", {
result <- c(
ncol(ncol(peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "sigma"))),
ncol(ncol(peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam")))
)
expect_equal(
unique(result),
3
)
})
test_that("peak_maxima() works with group_vars = NULL and alternate x and y variable names", {
result <- c(
ncol(peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "sigma")),
ncol(peak_maxima(tesdat, group_vars = NULL, x_var = "test_x", y_var = "test_y", method = "gam"))
)
expect_equal(
unique(result),
3
)
})
test()
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu", ]
tesdat <- tibble::tibble(
x = "a",
test_x = 1:100,
test_y = withr::with_seed(101, {stats::rlnorm(length(x), sdlog = 3)})
)
test_that("peak_maxima() yields the expected peaks", {
maxima <- peak_maxima(data, peaks = 3)
expect_equal(sort(unique(round(maxima$time))), c(12, 14, 20, 21))
})
peak_maxima(data, peaks = 3)
rm(list=ls())
test()
document()
test()
document()
test()
run_examples()
rm(list = ls())
?peak_maxima
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu", ]
peak_maxima(data, peaks = 3)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line()
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima()
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(),
col = "red"
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3),
col = "red"
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "gam"),
col = "red"
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma"),
col = "red"
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma", n = 3),
col = "red"
)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma", n = 5),
col = "red"
)
use_r("peak_maxima")
use_test("peak_maxima")
tesdat <- tibble::tibble(
x = "a",
test_x = 1:100,
test_y = withr::with_seed(101, {stats::rlnorm(length(x), sdlog = 3)})
)
tesdat$test_y[4] <- NA_real_
peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "sigma")
peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "gam")
group_peaks <- function(x) {
x <- c(0, x) # pad x with a zero so that x[i-1] exists when i=1
g <- rep(NA_real_, length(x))
counter <- 0
for(i in 2:length(x)) {
if(x[i] == 0) {
g[i] <- 0
} else if(x[i] == 1 & x[i] == x[i-1]) {
g[i] <- counter
} else {
counter <- counter + 1
g[i] <- counter
}
}
g[-1]
}
group_peaks(c(1,1,1,0,0,0,1,1))
group_peaks(c(1,1,1,0,NA,0,1,1))
peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "sigma")
peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "sigma", n = 3)
?vars()
document()
data <- data %>%
dplyr::mutate_at(dplyr::vars(c(.data[[x_var]], .data[[y_var]])), imputeTS::na_interpolation)
rm(list = c("group_peaks"))
document()
test_that("peak_maxima() handles NA", {
tesdat$test_y[4] <- NA_real_
expect_equal(
ncol(peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "sigma")),
4
)
})
test_that("peak_maxima() handles NA", {
tesdat$test_y[4] <- NA_real_
expect_equal(
ncol(peak_maxima(tesdat, group_vars = "x", x_var = "test_x", y_var = "test_y", method = "sigma")),
4
)
})
rm(list = ls())
test()
?use_r("peak_maxima")
use_r("peak_maxima")
?all_vars
document()
rm(list = ls())
test()
?peak_maxima
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu", ]
peak_maxima(data, peaks = 3)
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma", n = 5),
col = "red"
)
document()
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma", n = 5),
col = "red"
)
load_all()
data %>%
ggplot(aes(time, conc)) +
facet_wrap(vars(sample)) +
geom_line() +
geom_point(
data = function(x) x %>%
peak_maxima(peaks = 3, method = "sigma", n = 5),
col = "red"
)
rm(list = ls())
check()
use_r("peak_maxima")
tibble(a = 1, b = 2, c = 3) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.x)))
tibble(a = 1, b = 2, c = 3) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.)))
?any_vars
?filter_at
use_r("correct_baseline")
tibble(a = 1, b = 2, c = 3) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.data)))
tibble(a = 1, b = NA, c = 3) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.data)))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.data)))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter_at(vars(c(a, b)), any_vars(!is.na(.data)))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter_at(vars(c(a, b)), all_vars(!is.na(.data)))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter_at(vars(c(a, b)), all_vars(!is.na(.)))
document()
check()
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(a, b))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), !is.na)
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), !is.na(.))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_any(c(a, b)), !is.na(.))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), !is.na(.))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), ~ !is.na(.x))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), ~ !is.na(.data))
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) %>% filter(if_all(c(a, b)), ~ !is.na(utils::globalVariables(".")))
document()
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4)
tibble(a = c(1, 2), b = c(NA, 3), c = 3:4) -> test
test
test[is.na(test$b, )]
test[is.na(test$b), ]
test[!is.na(test$b), ]
document()
document()
document()
check()
library(devtools)
document()
check*
check()
library(devtools)
use_r("load_icp")
?rename_at
?fill
document()
?load_all()
load_all()
?load_icp
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
document()
load_all()
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
load_all()
document()
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
document()
seq_len(0)
document()
check()
document()
document()
document()
load_all()
?load_icp
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
check()
document()
check()
document()
load_all()
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
check()
document()
library(devtools)
document()
check()
library(devtools)
document()
check()
dpcument()
document()
?load_icp
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
path <- system.file("extdata", package = "fffprocessr")
path
list.files(path)
list.files(path, full.names = TRUE)
x <- "/Users/cwrs/Documents/GitHub/fffprocessr/inst/extdata/2021-03-16_bennery_raw.csv"
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) %>%
dplyr::mutate(
date = stringr::str_extract(file, date_regex) %>%
as.Date(date_format)
)
metadata <- 1
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) %>%
dplyr::mutate(
date = stringr::str_extract(file, date_regex) %>%
as.Date(date_format)
)
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
)
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric)
data_format = "x-series II"
read_fun <- function(x) {
if(data_format == "x-series II") {
metadata <- 1
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) %>%
dplyr::mutate(
date = stringr::str_extract(file, date_regex) %>%
as.Date(date_format)
)
} else if(data_format == "iCAP-RQ") {
readr::read_delim(x, delim = ";", skip = 1) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
dplyr::rename_at(
dplyr::vars(tidyselect::matches("^\\d")),
~ paste("cps", .x, sep = " ")
) %>%
tidyr::pivot_longer(
tidyselect::matches("^Time|^cps"),
names_to = c(".value", "param"),
names_sep = " "
) %>%
dplyr::mutate(
date = stringr::str_extract(file, date_regex) %>%
as.Date(date_format)
)
} else stop("Choose a valid data format ('x-series II' or 'iCAP-RQ')")
}
x %>%
rlang::set_names() %>%
purrr::map_dfr(read_fun, .id = "file")
read_fun <- function(x) {
if(data_format == "x-series II") {
metadata <- 1
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) #%>%
#dplyr::mutate(
# date = stringr::str_extract(file, date_regex) %>%
#  as.Date(date_format)
#)
} else if(data_format == "iCAP-RQ") {
readr::read_delim(x, delim = ";", skip = 1) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
dplyr::rename_at(
dplyr::vars(tidyselect::matches("^\\d")),
~ paste("cps", .x, sep = " ")
) %>%
tidyr::pivot_longer(
tidyselect::matches("^Time|^cps"),
names_to = c(".value", "param"),
names_sep = " "
) %>%
dplyr::mutate(
date = stringr::str_extract(file, date_regex) %>%
as.Date(date_format)
)
} else stop("Choose a valid data format ('x-series II' or 'iCAP-RQ')")
}
x %>%
rlang::set_names() %>%
purrr::map_dfr(read_fun, .id = "file")
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
)
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) %>%
mutate(time = as.numeric(.data$Time) / 6e4)
readr::read_csv(x, col_types = readr::cols(.default = readr::col_character())) %>%
# remove metadata after column names but before data:
dplyr::filter(!dplyr::row_number() %in% seq_len(metadata)) %>%
dplyr::mutate_at(dplyr::vars(tidyselect::matches("^\\d")), as.numeric) %>%
tidyr::pivot_longer(
cols = tidyselect::matches("^\\d"),
names_to = "param", values_to = "cps"
) %>%
dplyr::mutate(time = as.numeric(.data$Time) / 6e4)
3180 / 60
document()
path <- system.file("extdata", package = "fffprocessr")
load_icp(path = path)
check()
document()
check()
library(devtools)
document()
check()
document
document()
check()
install.packages("katex")
library("katex")
?math_to_rd
eqn1 <- "y = \frac{h\sigma}{\tau}\sqrt{\frac{\pi}{2}} exp\left(\frac{1}{2}(\frac{\sigma}{\tau})^2 - \frac{x-\mu}{\tau}\right)erfc\left(\frac{1}{\sqrt{2}}\left(\frac{\sigma}{\tau} - \frac{x-\mu}{\sigma}\right)\right)"
str_replace(eqn1)
library("tidyverse")
str_replace(eqn1)
str_replace(eqn1, "\\\")
str_replace(eqn1, "\", "\\")
str_replace(eqn1, "\", "a")
str_replace(eqn1, "\\\\", "a")
eqn1 <- "y = \frac{h\sigma}{\tau}\sqrt{\frac{\pi}{2}} exp\left(\frac{1}{2}(\frac{\sigma}{\tau})^2 - \frac{x-\mu}{\tau}\right)erfc\left(\frac{1}{\sqrt{2}}\left(\frac{\sigma}{\tau} - \frac{x-\mu}{\sigma}\right)\right)"
eqn1 <- "y = \\frac{h\\sigma}{\\tau}\\sqrt{\\frac{\\pi}{2}} exp\\left(\\frac{1}{2}(\\frac{\\sigma}{\\tau})^2 - \\frac{x-\\mu}{\\tau}\\right)erfc\\left(\\frac{1}{\\sqrt{2}}\\left(\\frac{\\sigma}{\\tau} - \\frac{x-\\mu}{\\sigma}\\right)\\right)"
katex::math_to_rd(eqn)
katex::math_to_rd(eqn1)
rmarkdown::render("README.Rmd", "md_document")
katex::katex_html(eqn1, preview = TRUE)
rmarkdown::render("README.Rmd", "md_document")
katex::katex_mathml(eqn1, preview = TRUE)
rmarkdown::render("README.Rmd", "md_document")
rmarkdown::render("README.Rmd", "md_document")
rmarkdown::render("README.Rmd", "md_document")
rmarkdown::render("README.Rmd", "md_document")

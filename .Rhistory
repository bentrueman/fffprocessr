geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = min(c(nrow(icp) / 10, 50)))) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = 20 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff() %>%
filter(param == "65Cu", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = min(c(nrow(icp) / 10, 50)))) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = 20 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = min(c(nrow(icp) / 10, 50)))) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50))) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50))) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff() %>%
filter(param == "238U", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .2 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
group_by(region) %>%
mutate(tr = max(conc), time_tr = time[which.max(conc)]) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% 1:3) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% seq_len(3)) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff() %>%
filter(param == "65Cu", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% seq_len(3)) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff() %>%
filter(param == "56Fe", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% seq_len(3)) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff() %>%
filter(param == "UV254_1", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% seq_len(3)) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
icp <- load_icp(path) %>%
combine_fff(load_uv(path, UV254_1, UV254_2)) %>%
filter(param == "UV254_2", sample == "sample_bennery_raw")
icp %>%
filter(time > 10) %>%
mutate(
fitted = mgcv::gam(conc ~ s(time, bs = "cs", k = 50)) %>%
predict(),
diff = lead(fitted) - fitted, # slope
sign = sign(diff), # sign of slope
diff_sign = lead(sign) - sign, # delta sign of slope
region = cumsum(diff_sign > 0)
) %>%
filter(region %in% seq_len(3)) %>%
group_by(region) %>%
mutate(
tr = max(conc),
time_tr = time[which.max(conc)]
) %>%
ungroup() %>%
ggplot(aes(time)) +
geom_vline(
data = function(x) x %>%
filter(diff_sign > 0),
aes(xintercept = time)
) +
geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = .02 * region)) +
geom_line(aes(y = conc)) +
geom_line(aes(y = fitted), col = "red") +
geom_line(aes(y = diff))
?lead
?sign
?cumsum
path <- system.file("extdata", package = "fffprocessr")
icp <- load_icp(path) %>%
combine_fff(load_uv(path, UV254_1, UV254_2)) %>%
filter(param == "65Cu", sample == "sample_bennery_raw")
data <- load_icp(path) %>%
combine_fff(load_uv(path, UV254_1, UV254_2)) %>%
filter(param == "65Cu", sample == "sample_bennery_raw")
data %>%
ggplot(aes(time)) +
#geom_point(data = function(x) distinct(x, region, time_tr, tr), aes(x = time_tr, y = tr)) +
geom_line(aes(y = conc))
data %>%
ggplot(aes(time)) +
geom_point(data = function(x) peak_maxima(x), aes(x = tr, y = conc_tr)) +
geom_line(aes(y = conc))
peak_maxima <- function(data, focus = 10, k = 50, peaks = 1) {
data %>%
dplyr::filter(.data$time > focus) %>%
dplyr::mutate(
fitted = mgcv::gam(.data$conc ~ s(.data$time, bs = "cs", k = k)) %>%
mgcv::predict(),
diff = dplyr::lead(.data$fitted) - .data$fitted, # slope
sign = sign(.data$diff), # sign of slope
diff_sign = lead(.data$sign) - .data$sign, # delta sign of slope
region = cumsum(.data$diff_sign > 0)
) %>%
dplyr::filter(region %in% seq_len(peaks)) %>%
dplyr::group_by(region) %>%
dplyr::summarize(
conc_tr = max(.data$conc),
tr = .data$time[which.max(.data$conc)]
) %>%
ungroup()
}
data %>%
ggplot(aes(time)) +
geom_point(data = function(x) peak_maxima(x), aes(x = tr, y = conc_tr)) +
geom_line(aes(y = conc))
?predict
?predict.mgcv
mgcv::predict.mgcv
mgcv::predict
?mgcv::predict
?mgcv::predict.gm
?mgcv::predict.gam
peak_maxima <- function(data, focus = 10, k = 50, peaks = 1) {
data %>%
dplyr::filter(.data$time > focus) %>%
dplyr::mutate(
fitted = mgcv::gam(.data$conc ~ s(.data$time, bs = "cs", k = k)) %>%
mgcv::predict.gam(),
diff = dplyr::lead(.data$fitted) - .data$fitted, # slope
sign = sign(.data$diff), # sign of slope
diff_sign = lead(.data$sign) - .data$sign, # delta sign of slope
region = cumsum(.data$diff_sign > 0)
) %>%
dplyr::filter(region %in% seq_len(peaks)) %>%
dplyr::group_by(region) %>%
dplyr::summarize(
conc_tr = max(.data$conc),
tr = .data$time[which.max(.data$conc)]
) %>%
ungroup()
}
data %>%
ggplot(aes(time)) +
geom_point(data = function(x) peak_maxima(x), aes(x = tr, y = conc_tr)) +
geom_line(aes(y = conc))
data %>%
ggplot(aes(time)) +
geom_point(data = function(x) peak_maxima(x, peaks = 3), aes(x = tr, y = conc_tr)) +
geom_line(aes(y = conc))
data %>%
ggplot(aes(time)) +
geom_point(data = function(x) peak_maxima(x, peaks = 3), aes(x = tr, y = conc_tr), col = "red") +
geom_line(aes(y = conc))
rm(list=ls())
document()
load_all()
use_package("mgcv")
document()
load_all
load_all()
?peak_maxima
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[param == "65Cu" & sample == "sample_bennery_raw", ]
peak_maxima(data, peaks = 3)
document()
?peak_maxima
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu" & data$sample == "sample_bennery_raw", ]
peak_maxima(data, peaks = 3)
data %>% ggplot(aes(time, conc)) + geom_line()
data %>% ggplot(aes(time, conc)) + geom_line() + geom_point(data = peak_maxima(data, peaks = 3), aes(tr, conc_tr))
data %>% ggplot(aes(time, conc)) + geom_line() + geom_point(data = peak_maxima(data, peaks = 3), aes(tr, conc_tr), col = "red")
document()
check()
use_r("peak_maxima")
document()
?peak_maxima
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu" & data$sample == "sample_bennery_raw", ]
peak_maxima(data, peaks = 3)
check()
path <- system.file("extdata", package = "fffprocessr")
data <- combine_fff(load_icp(path))
data <- data[data$param == "65Cu" & data$sample == "sample_bennery_raw", ]
peak_maxima(data, peaks = 3)
build_readme()
build_readme()
